name: Benchmark Tests

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Benchmark each test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Install Rust nightly
        run: rustup default nightly

      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Build tests (both branches)
        run: |
          cd pr
          cargo test --no-run 2>&1
          find target/debug/deps -maxdepth 1 -name 'integration_test-*' -type f -executable | head -1 > ../pr-test-binary.txt

          cd ../base
          cargo test --no-run 2>&1
          find target/debug/deps -maxdepth 1 -name 'integration_test-*' -type f -executable | head -1 > ../base-test-binary.txt

          echo "PR binary: $(cat ../pr-test-binary.txt)"
          echo "Base binary: $(cat ../base-test-binary.txt)"

      - name: Get test list
        run: |
          PR_BIN=$(cat pr-test-binary.txt)
          echo "Using PR binary: $PR_BIN"

          # Get list of all tests (excluding benchmarks)
          "$PR_BIN" --list 2>&1 | tee test-list-raw.txt
          grep ': test$' test-list-raw.txt | sed 's/: test$//' > test-names.txt

          echo "Found $(wc -l < test-names.txt) tests:"
          head -20 test-names.txt

      - name: Benchmark each test
        shell: bash
        run: |
          PR_BIN=$(cat pr-test-binary.txt)
          BASE_BIN=$(cat base-test-binary.txt)

          echo "## Test Benchmark Comparison" > comparison.md
          echo "" >> comparison.md
          echo "Comparing \`${{ github.head_ref }}\` against \`${{ github.base_ref }}\` using [hyperfine](https://github.com/sharkdp/hyperfine)" >> comparison.md
          echo "" >> comparison.md
          echo "| Test | Base | PR | Change |" >> comparison.md
          echo "|------|------|-----|--------|" >> comparison.md

          while IFS= read -r test_name; do
            [ -z "$test_name" ] && continue
            echo "Benchmarking: $test_name"

            # Create wrapper scripts to avoid quoting issues
            echo "#!/bin/bash" > run_base.sh
            echo "exec '$BASE_BIN' --exact '$test_name' --test-threads=1" >> run_base.sh
            chmod +x run_base.sh

            echo "#!/bin/bash" > run_pr.sh
            echo "exec '$PR_BIN' --exact '$test_name' --test-threads=1" >> run_pr.sh
            chmod +x run_pr.sh

            # Run hyperfine for this specific test
            if ! hyperfine \
              --warmup 2 \
              --min-runs 20 \
              --export-json "bench-result.json" \
              --style none \
              -n "base" "./run_base.sh" \
              -n "pr" "./run_pr.sh" 2>&1; then
              echo "  Failed to benchmark $test_name"
              continue
            fi

            # Extract results using jq array indexing (base is first, pr is second)
            BASE_MEAN=$(jq -r '.results[0].mean' bench-result.json)
            PR_MEAN=$(jq -r '.results[1].mean' bench-result.json)

            echo "  Base mean: $BASE_MEAN, PR mean: $PR_MEAN"

            if [ -n "$BASE_MEAN" ] && [ -n "$PR_MEAN" ] && [ "$BASE_MEAN" != "null" ] && [ "$PR_MEAN" != "null" ]; then
              # Format times (convert to ms if < 1s)
              BASE_FMT=$(awk "BEGIN {if ($BASE_MEAN < 1) printf \"%.2f ms\", $BASE_MEAN * 1000; else printf \"%.3f s\", $BASE_MEAN}")
              PR_FMT=$(awk "BEGIN {if ($PR_MEAN < 1) printf \"%.2f ms\", $PR_MEAN * 1000; else printf \"%.3f s\", $PR_MEAN}")

              CHANGE=$(awk "BEGIN {printf \"%.1f\", (($PR_MEAN - $BASE_MEAN) / $BASE_MEAN) * 100}")

              if (( $(echo "$CHANGE < -5" | bc -l) )); then
                INDICATOR="ðŸŸ¢ ${CHANGE}%"
              elif (( $(echo "$CHANGE > 5" | bc -l) )); then
                INDICATOR="ðŸ”´ +${CHANGE}%"
              else
                INDICATOR="âšª ${CHANGE}%"
              fi

              echo "| \`$test_name\` | $BASE_FMT | $PR_FMT | $INDICATOR |" >> comparison.md
            fi
          done < test-names.txt

          echo "" >> comparison.md
          echo "Legend: ðŸŸ¢ faster (>5%) | ðŸ”´ slower (>5%) | âšª within 5%" >> comparison.md

          cat comparison.md

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        if: github.event_name == 'pull_request'
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Test Benchmark Comparison'

      - name: Post or update comment
        uses: peter-evans/create-or-update-comment@v4
        if: github.event_name == 'pull_request'
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body-path: comparison.md
          edit-mode: replace
